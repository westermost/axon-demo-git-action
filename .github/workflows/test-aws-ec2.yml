name: Python Tests on AWS EC2 (SSM)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      instance_id:
        description: 'EC2 Instance ID'
        required: true
        default: 'i-0cd39c0cf451a83cc'
      s3_bucket:
        description: 'S3 Bucket for results'
        required: true
        default: 'kiemtraxe'

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: ap-southeast-1
  INSTANCE_ID: ${{ github.event.inputs.instance_id || 'i-0cd39c0cf451a83cc' }}
  S3_BUCKET: ${{ github.event.inputs.s3_bucket || 'kiemtraxe' }}

jobs:
  test-on-ec2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Start EC2 instance
        run: |
          echo "Starting EC2 instance ${{ env.INSTANCE_ID }}"
          aws ec2 start-instances --instance-ids ${{ env.INSTANCE_ID }}
          aws ec2 wait instance-running --instance-ids ${{ env.INSTANCE_ID }}
          echo "‚úì Instance started"

      - name: Wait for SSM agent
        run: |
          echo "Waiting for SSM agent to be ready..."
          sleep 30

          for i in {1..12}; do
            STATUS=$(aws ssm describe-instance-information \
              --filters "Key=InstanceIds,Values=${{ env.INSTANCE_ID }}" \
              --query 'InstanceInformationList[0].PingStatus' \
              --output text 2>/dev/null || echo "Unknown")

            echo "SSM Status: $STATUS"
            if [ "$STATUS" = "Online" ]; then
              echo "‚úì SSM agent is ready"
              break
            fi
            sleep 10
          done

      - name: Cleanup old data
        run: |
          echo "=== Cleaning up old test data and reports ==="
          
          CLEANUP_CMD=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "echo === Finding old test directories (>1 hour) ===",
              "OLD_DIRS=$(find /tmp -maxdepth 1 -name \"test-*\" -type d -mmin +60 2>/dev/null)",
              "echo \"$OLD_DIRS\"",
              "echo === Killing HTTP servers for old directories ===",
              "for dir in $OLD_DIRS; do",
              "  RUN_ID=$(basename $dir | sed \"s/test-//\")",
              "  echo \"Checking server for $RUN_ID\"",
              "  pkill -f \"allure-server-$RUN_ID.log\" 2>/dev/null && echo \"Killed server for $RUN_ID\" || echo \"No server for $RUN_ID\"",
              "done",
              "echo === Removing old test directories ===",
              "find /tmp -maxdepth 1 -name \"test-*\" -type d -mmin +60 -exec rm -rf {} + 2>/dev/null || echo No old directories",
              "echo === Removing old server logs ===",
              "find /tmp -maxdepth 1 -name \"allure-server-*.log\" -mmin +60 -delete 2>/dev/null || echo No old logs",
              "echo === Current active test directories ===",
              "ls -lt /tmp/ | grep test- | head -5 || echo No test directories",
              "echo === Current running HTTP servers ===",
              "ps aux | grep \"python3 -m http.server\" | grep -v grep || echo No servers running"
            ]' \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Cleanup Command ID: $CLEANUP_CMD"
          
          # Wait for cleanup to complete
          for i in {1..10}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id $CLEANUP_CMD \
              --instance-id ${{ env.INSTANCE_ID }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            echo "Cleanup Status: $STATUS"
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ]; then
              break
            fi
            sleep 2
          done
          
          # Show cleanup output
          echo "=== Cleanup Output ==="
          aws ssm get-command-invocation \
            --command-id $CLEANUP_CMD \
            --instance-id ${{ env.INSTANCE_ID }} \
            --query 'StandardOutputContent' \
            --output text

      - name: Setup environment on EC2
        id: setup
        run: |
          RUN_ID=$(date +%Y%m%d-%H%M%S)
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          
          echo "Setting up environment..."
          SETUP_CMD=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /tmp && rm -rf test-'$RUN_ID' && mkdir test-'$RUN_ID' && cd test-'$RUN_ID'",
              "echo === Installing git ===",
              "sudo yum install -y git",
              "git --version",
              "echo === Cloning repository ===",
              "git clone https://github.com/${{ github.repository }}.git .",
              "echo === Checking out correct ref ===",
              "git fetch origin ${{ github.ref }}",
              "git checkout ${{ github.sha }}",
              "echo === Current branch/commit ===",
              "git log -1 --oneline",
              "echo === Verify clone ===",
              "ls -la",
              "ls -la tests/",
              "echo === Installing dependencies ===",
              "sudo yum install -y python3-pip java-17-amazon-corretto-headless",
              "pip3 install -r requirements.txt",
              "echo === Downloading Allure ===",
              "wget -q https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz",
              "tar -xzf allure-2.25.0.tgz",
              "echo Setup completed"
            ]' \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Setup Command ID: $SETUP_CMD"
          
          # Wait for setup to complete
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id $SETUP_CMD \
              --instance-id ${{ env.INSTANCE_ID }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            echo "Setup Status: $STATUS"
            if [ "$STATUS" = "Success" ]; then
              echo "Setup completed successfully"
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "Setup failed"
              exit 1
            fi
            sleep 5
          done
          
          # Show setup output
          echo "=== Setup Output ==="
          aws ssm get-command-invocation \
            --command-id $SETUP_CMD \
            --instance-id ${{ env.INSTANCE_ID }} \
            --query 'StandardOutputContent' \
            --output text
      
      - name: Run tests on EC2
        id: run_tests
        run: |
          RUN_ID=${{ steps.setup.outputs.run_id }}
          
          echo "Running tests..."
          TEST_CMD=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /tmp/test-'$RUN_ID'",
              "echo === Current directory ===",
              "pwd",
              "echo === List all files ===",
              "ls -la",
              "echo === Test directory ===",
              "ls -la tests/",
              "echo === Test file content ===",
              "cat tests/test_simple.py",
              "echo === Running pytest ===",
              "python3 -m pytest tests/ -v --html=report.html --self-contained-html --alluredir=allure-results",
              "echo === Upload HTML report ===",
              "aws s3 cp report.html s3://${{ env.S3_BUCKET }}/'$RUN_ID'/report.html --content-type text/html",
              "echo Tests completed"
            ]' \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Test Command ID: $TEST_CMD"
          
          # Wait for tests to complete
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id $TEST_CMD \
              --instance-id ${{ env.INSTANCE_ID }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            echo "Test Status: $STATUS"
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ]; then
              break
            fi
            sleep 5
          done
          
          # Show output
          echo "=== Test Output ==="
          aws ssm get-command-invocation \
            --command-id $TEST_CMD \
            --instance-id ${{ env.INSTANCE_ID }} \
            --query 'StandardOutputContent' \
            --output text
      
      - name: Generate Allure report on EC2
        run: |
          RUN_ID=${{ steps.setup.outputs.run_id }}
          
          echo "Generating Allure report..."
          ALLURE_CMD=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /tmp/test-'$RUN_ID'",
              "./allure-2.25.0/bin/allure generate allure-results -o allure-report --clean",
              "echo Allure report generated"
            ]' \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Allure Command ID: $ALLURE_CMD"
          
          # Wait for generation to complete
          for i in {1..20}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id $ALLURE_CMD \
              --instance-id ${{ env.INSTANCE_ID }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            echo "Allure Status: $STATUS"
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ]; then
              break
            fi
            sleep 3
          done
      
      - name: Upload Allure report to S3
        run: |
          RUN_ID=${{ steps.setup.outputs.run_id }}
          
          echo "Uploading Allure report..."
          UPLOAD_CMD=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /tmp/test-'$RUN_ID'",
              "aws s3 sync allure-report/ s3://${{ env.S3_BUCKET }}/'$RUN_ID'/allure-report/ --content-type text/html --exclude \"*\" --include \"*.html\"",
              "aws s3 sync allure-report/ s3://${{ env.S3_BUCKET }}/'$RUN_ID'/allure-report/ --exclude \"*.html\"",
              "tar -czf allure-report.tar.gz allure-report/",
              "aws s3 cp allure-report.tar.gz s3://${{ env.S3_BUCKET }}/'$RUN_ID'/allure-report.tar.gz",
              "echo Upload completed"
            ]' \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Upload Command ID: $UPLOAD_CMD"
          
          # Wait for upload to complete
          for i in {1..20}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id $UPLOAD_CMD \
              --instance-id ${{ env.INSTANCE_ID }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            echo "Upload Status: $STATUS"
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ]; then
              break
            fi
            sleep 3
          done
          
          echo ""
          echo "üìä Reports:"
          echo "Pytest HTML: https://${{ env.S3_BUCKET }}.s3.ap-southeast-1.amazonaws.com/$RUN_ID/report.html"
          echo "Allure Report (online): https://${{ env.S3_BUCKET }}.s3.ap-southeast-1.amazonaws.com/$RUN_ID/allure-report/index.html"
          echo "Allure Report (zip): https://${{ env.S3_BUCKET }}.s3.ap-southeast-1.amazonaws.com/$RUN_ID/allure-report.tar.gz"
      
      - name: Start new Allure server
        run: |
          RUN_ID=${{ steps.setup.outputs.run_id }}
          PORT=$((8000 + ${{ github.run_number }} % 100))
          
          # Get EC2 public IP
          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          
          echo "=== Starting HTTP server for Allure report ==="
          echo "Report directory: /tmp/test-$RUN_ID/allure-report"
          echo "Port: $PORT"
          
          START_CMD=$(aws ssm send-command \
            --instance-ids ${{ env.INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /tmp/test-'$RUN_ID'/allure-report || exit 1",
              "echo === Starting HTTP server on port '$PORT' ===",
              "nohup python3 -m http.server '$PORT' > /tmp/allure-server-'$RUN_ID'.log 2>&1 &",
              "sleep 2",
              "echo === Verifying server started ===",
              "ps aux | grep \"python3 -m http.server '$PORT'\" | grep -v grep || echo Server not found",
              "netstat -tuln | grep '$PORT' || ss -tuln | grep '$PORT' || echo Port check failed",
              "echo === Server started on port '$PORT' ==="
            ]' \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Start Command ID: $START_CMD"
          
          # Wait for start to complete
          for i in {1..10}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id $START_CMD \
              --instance-id ${{ env.INSTANCE_ID }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")
            echo "Start Status: $STATUS"
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ]; then
              break
            fi
            sleep 2
          done
          
          # Show start output
          echo "=== Start Output ==="
          aws ssm get-command-invocation \
            --command-id $START_CMD \
            --instance-id ${{ env.INSTANCE_ID }} \
            --query 'StandardOutputContent' \
            --output text
          
          echo ""
          echo "üåê Allure Report Server:"
          echo "URL: http://$PUBLIC_IP:$PORT"
          echo "Run ID: $RUN_ID"
          echo ""
          echo "‚ö†Ô∏è  Make sure Security Group allows inbound traffic on port $PORT"
          echo "To add rule: aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port $PORT --cidr 0.0.0.0/0"
