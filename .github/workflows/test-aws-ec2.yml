name: Playwright Tests on AWS EC2 (SSM)

on:
  workflow_dispatch:
    inputs:
      instance_id:
        description: 'EC2 Instance ID'
        required: true
        default: 'i-0cd39c0cf451a83cc'
      s3_bucket:
        description: 'S3 Bucket for results'
        required: true
        default: 'kiemtraxe'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-southeast-1

jobs:
  test-on-ec2:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Start EC2 instance
        run: |
          echo "Starting EC2 instance ${{ github.event.inputs.instance_id }}"
          aws ec2 start-instances --instance-ids ${{ github.event.inputs.instance_id }}
          aws ec2 wait instance-running --instance-ids ${{ github.event.inputs.instance_id }}
          echo "✓ Instance started"

      - name: Wait for SSM agent
        run: |
          echo "Waiting for SSM agent to be ready..."
          sleep 30

          for i in {1..12}; do
            STATUS=$(aws ssm describe-instance-information \
              --filters "Key=InstanceIds,Values=${{ github.event.inputs.instance_id }}" \
              --query 'InstanceInformationList[0].PingStatus' \
              --output text 2>/dev/null || echo "Unknown")

            echo "SSM Status: $STATUS"
            if [ "$STATUS" = "Online" ]; then
              echo "✓ SSM agent is ready"
              break
            fi
            sleep 10
          done

      - name: Setup and run tests on EC2
        id: run_tests
        run: |
          RUN_ID=$(date +%Y%m%d-%H%M%S)
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

          echo "Setting up environment and running tests on EC2..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ github.event.inputs.instance_id }} \
            --document-name "AWS-RunShellScript" \
            --timeout-seconds 1800 \
            --parameters 'commands=[
              "echo \"=== Installing Docker ===\"",
              "sudo yum install -y docker",
              "sudo systemctl start docker",
              "sudo usermod -a -G docker ssm-user",
              "echo \"=== Cloning repository ===\"",
              "cd /tmp && rm -rf test-run-'$RUN_ID'",
              "mkdir -p test-run-'$RUN_ID' && cd test-run-'$RUN_ID'",
              "git clone https://github.com/${{ github.repository }}.git .",
              "echo \"=== Running tests in Docker ===\"",
              "sudo docker run --rm -v $(pwd):/work -w /work mcr.microsoft.com/playwright:v1.48.0-jammy /bin/bash -c \"npm ci && npx playwright install chromium && npm test\" || true",
              "echo \"=== Test results ===\"",
              "ls -la playwright-report/ allure-results/ || echo \"No reports found\"",
              "echo \"=== Uploading to S3 ===\"",
              "tar -czf results.tar.gz playwright-report/ allure-results/ || true",
              "aws s3 cp results.tar.gz s3://${{ github.event.inputs.s3_bucket }}/'$RUN_ID'/results.tar.gz || echo \"Failed to upload tar\"",
              "aws s3 cp playwright-report/ s3://${{ github.event.inputs.s3_bucket }}/'$RUN_ID'/playwright-report/ --recursive || echo \"No playwright-report\"",
              "aws s3 cp allure-results/ s3://${{ github.event.inputs.s3_bucket }}/'$RUN_ID'/allure-results/ --recursive || echo \"No allure-results\"",
              "echo \"=== Completed ===\""
            ]' \
            --query 'Command.CommandId' \
            --output text)

          echo "Test Command ID: $COMMAND_ID"

          # Wait for completion
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id $COMMAND_ID \
              --instance-id ${{ github.event.inputs.instance_id }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            echo "[$i/60] Test Status: $STATUS"

            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ]; then
              break
            fi
            sleep 10
          done

          # Get output
          echo "=== Test Output ==="
          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ github.event.inputs.instance_id }} \
            --query 'StandardOutputContent' \
            --output text

      - name: Download test results from S3
        if: always()
        run: |
          RUN_ID=${{ steps.setup.outputs.run_id }}
          mkdir -p test-results

          echo "Downloading results from S3..."
          aws s3 cp s3://${{ github.event.inputs.s3_bucket }}/$RUN_ID/ test-results/ --recursive || true

          ls -la test-results/

      - name: Extract results
        if: always()
        run: |
          cd test-results
          if [ -f results.tar.gz ]; then
            tar -xzf results.tar.gz
            ls -la
          fi

      - name: Generate Allure report
        if: always()
        run: |
          if [ -d test-results/allure-results ]; then
            npm install -g allure-commandline
            allure generate test-results/allure-results -o allure-report --clean
          fi

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-ec2
          path: test-results/playwright-report/
          retention-days: 30

      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-ec2
          path: allure-report/
          retention-days: 30

      - name: Stop EC2 instance
        if: always()
        run: |
          echo "Stopping EC2 instance..."
          aws ec2 stop-instances --instance-ids ${{ github.event.inputs.instance_id }}
          echo "✓ Instance stopped"
